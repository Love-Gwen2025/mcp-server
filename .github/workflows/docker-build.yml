# GitHub Actions - è‡ªåŠ¨æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯ æˆ– åˆ›å»º tag

name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'  # æ¨é€ v1.0.0 è¿™æ ·çš„ tag æ—¶è§¦å‘
  pull_request:
    branches:
      - main
      - master

env:
  # Docker é•œåƒåç§°ï¼ˆæ”¹æˆä½ çš„ç”¨æˆ·å/ä»“åº“åï¼‰
  IMAGE_NAME: mcp-server

jobs:
  build:
    runs-on: ubuntu-latest
    # æ·»åŠ æƒé™ï¼šå…è®¸æ¨é€åˆ° GHCR
    permissions:
      contents: read
      packages: write
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æ„å»ºï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½•åˆ° GitHub Container Registry
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. æå–å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€ç‰ˆæœ¬å·ç­‰ï¼‰
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            # åˆ†æ”¯åä½œä¸ºæ ‡ç­¾ï¼ˆmain -> latestï¼‰
            type=ref,event=branch
            # tag ä½œä¸ºç‰ˆæœ¬å·ï¼ˆv1.0.0 -> 1.0.0ï¼‰
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # çŸ­ commit hash
            type=sha,prefix=

      # 5. æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ç¼“å­˜åŠ é€Ÿæ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # å¤šå¹³å°æ”¯æŒï¼ˆå¯é€‰ï¼Œå»æ‰æ³¨é‡Šå¯ç”¨ï¼‰
          # platforms: linux/amd64,linux/arm64

      # 6. è¾“å‡ºé•œåƒä¿¡æ¯
      - name: Image info
        if: github.event_name != 'pull_request'
        run: |
          echo "ğŸ‰ é•œåƒå·²æ¨é€åˆ° GitHub Container Registry"
          echo "ğŸ“¦ é•œåƒåœ°å€: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          echo "ğŸ·ï¸ æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
